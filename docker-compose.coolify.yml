############################################################
# STREAMSIDE LIVEKIT - PRODUCTION CONFIG WITH TRAEFIK SSL
############################################################
# Uses Traefik for SSL on WebSocket (port 7880)
# UDP ports exposed directly for media performance
#
# COOLIFY ENV VARS:
# - LIVEKIT_API_KEY    (e.g., APIStreamside)
# - LIVEKIT_API_SECRET (your secret)
#
# FIREWALL: Open 7881, 3478, 50000-50100/udp
############################################################

services:
  livekit:
    image: livekit/livekit-server:latest
    container_name: livekit-server
    restart: unless-stopped
    ports:
      - "7881:7881/tcp"
      - "3478:3478/udp"
      - "50000-50100:50000-50100/udp"
    environment:
      LIVEKIT_CONFIG: |
        port: 7880
        bind_addresses:
          - "0.0.0.0"
        rtc:
          port_range_start: 50000
          port_range_end: 50100
          use_external_ip: true
          tcp_port: 7881
        turn:
          enabled: true
          udp_port: 3478
        keys:
          ${LIVEKIT_API_KEY}: ${LIVEKIT_API_SECRET}
        room:
          auto_create: true
          empty_timeout: 300
          max_participants: 80
        logging:
          level: info
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.livekit.rule=Host(`live.rohit.one`)"
      - "traefik.http.routers.livekit.entrypoints=websecure"
      - "traefik.http.routers.livekit.tls=true"
      - "traefik.http.routers.livekit.tls.certresolver=letsencrypt"
      - "traefik.http.services.livekit.loadbalancer.server.port=7880"
    deploy:
      resources:
        limits:
          cpus: '8'
          memory: 16G
        reservations:
          cpus: '4'
          memory: 8G
